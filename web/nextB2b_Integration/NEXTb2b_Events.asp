<% 
'......................................................................................................
'......................................................................................................
'FILE che dichiara le funzioni "evento"/"ADD-ON" per il next-b2b con le personalizzazioni per cliente
'......................................................................................................
'......................................................................................................

'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'GESTIONE EVENTI DEGLI ORDINI
'*********************************************************************************************************************************************************************************************************************************************************************************


'......................................................................................................
'	funzione richiamata in OrdiniSalva.asp All'inizio delle operazioni di inserimento.
'......................................................................................................
sub On_Order_NEW(conn, ID)
end sub

'......................................................................................................
'	funzione richiamata in OrdiniSalva.asp All'inizio delle operazioni di inserimento.
'......................................................................................................
'......................................................................................................
'	funzione richiamata in OrdiniSalva.asp All'inizio delle operazioni di inserimento.
'......................................................................................................
sub On_Order_CONFIRM(conn, ID)
	'......................................................................................................
	if Session("ERRORE")="" then
		'chiude transazione per invio email 
		dim rs, sql, url
		set rs = server.CreateObject("ADODB.Recordset")
		sql = " SELECT * " + _
			  " FROM gtb_ordini INNER JOIN gtb_magazzini ON gtb_ordini.ord_magazzino_id=gtb_magazzini.mag_id " + _
			  " INNER JOIN gtb_stati_ordine ON gtb_ordini.ord_stato_id = gtb_stati_ordine.so_id " + _
			  " INNER JOIN gv_rivenditori ON gtb_ordini.ord_riv_id = gv_rivenditori.riv_id " + _
			  " INNER JOIN gtb_listini ON gv_rivenditori.riv_listino_id = gtb_listini.listino_id " + _
			  " LEFT JOIN gtb_lista_codici ON gv_rivenditori.riv_LstCod_id = gtb_lista_codici.lstCod_id " + _
			  " WHERE ord_id=" & ID
		rs.open sql, conn, adOpenDynamic, adLockOptimistic
		url = GetPageSiteUrl(conn, Session("SHOPPING_CART_COMPLETATA_PAGE"), "it") & "&IDCNT=" & rs("IDElencoIndirizzi") & "&KEY=" & rs("codiceInserimento") & "&ID=" & rs("ord_id") & "&TYPEREQ=ORDINECOMPLETATO_PAGAMENTO_OK"
		rs.close
		'chiude transazione per ClassSalva per eseguire la generazione della pagina
		conn.commitTrans
		
		'esegue la pagina
		CALL ExecuteHttpUrl(url)
		
		'riapre transazione per ClassSalva
		conn.begintrans
	end if

end sub



'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'*********************************************************************************************************************************************************************************************************************************************************************************
'GESTIONE ADD-ON DEI CLIENTI
'*********************************************************************************************************************************************************************************************************************************************************************************


'......................................................................................................
'	funzione utilizzata nell'elenco dei clienti
'......................................................................................................
sub ADDON__CLIENTI__record_elenco(conn, rs) 
end sub


'......................................................................................................
'	funzione utilizzata nella costruzione del form di ricerca dei clienti
'......................................................................................................
sub ADDON__CLIENTI__ricerca_form(conn) 
end sub


'......................................................................................................
'	funzione utilizzata nel parsing del form di ricerca clienti
'......................................................................................................
sub ADDON__CLIENTI__ricerca_form_parse(conn, byRef sql)
end sub


'......................................................................................................
'	funzione utilizzata nella composizione del form di inserimento/modifica del cliente
'......................................................................................................
sub ADDON__CLIENTI__form_gestione(ObjContatto, rs)
end sub


'......................................................................................................
'	funzione utilizzata nel salvataggio dei dati cliente
'......................................................................................................
sub ADDON__CLIENTI__form_salva(ObjContatto, rs, riv_id)	
end sub


'*********************************************************************************************************************************************************************************************************************************************************************************
'GESTIONE ADD-ON ORDINI
'*********************************************************************************************************************************************************************************************************************************************************************************



'......................................................................................................
'	funzione utilizzata nell'elenco degli ordini
'......................................................................................................
sub ADDON__ORDINI__record_elenco(conn, rs)
	

end sub


'......................................................................................................
'	funzione utilizzata nella costruzione del form di ricerca degli ordini
'......................................................................................................
sub ADDON__ORDINI__ricerca_form(conn, rs)
end sub


'......................................................................................................
'	funzione utilizzata nel parsing del form di ricerca ordini
'......................................................................................................
sub ADDON__ORDINI__ricerca_form_parse(conn, byref sql)
end sub


'......................................................................................................
'	funzione utilizzata nella composizione del form di inserimento del nuovo ordine
'......................................................................................................
sub ADDON__ORDINI__form_insert(conn, rs)
end sub


'......................................................................................................
'	funzione utilizzata nella composizione del form di modifica dell'ordine
'......................................................................................................
sub ADDON__ORDINI__form_update(conn, rs)
	%>
	<table cellspacing="1" cellpadding="0" class="tabella_madre" style="border-bottom:0px;">
		<tr><th colspan="4">E-MAIL CONFERMA DELL'ORDINE</th></tr>
		<tr>
			<td class="content" colspan="3">In caso di errori nell'invio della conferma dell'ordine o di mancata ricezione dell'e-mail da parte del cliente clicca sul pulsante a destra per reinviare l'e-mail di conferma dell'ordine.</td>
			<td colspan="1" class="content_right" style="padding-right:0px;width:22%;">
				<a class="button_L2" style="width:100%;text-align:center;" href="<%= GetPageSiteUrl(conn, Session("SHOPPING_CART_COMPLETATA_PAGE"), "it") & "&IDCNT=" & rs("IDElencoIndirizzi") & "&KEY=" & rs("codiceInserimento") & "&ID=" & rs("ord_id") & "&TYPEREQ=ORDINECOMPLETATO"%>" target="_blank"	onclick="" title="conferma manuale dell'ordine" <%= ACTIVE_STATUS %>>
					REINVIA E-MAIL DI CONFERMA
				</a>
			</td>
		</tr>
	</table>
	<%
end sub


'......................................................................................................
'	funzione utilizzata nella composizione del piede dell'ordine come ultima riga dei dettagli
'......................................................................................................
sub ADDON__ORDINI__form_update_piede(conn, rs, rsd)
%>
	<tr>
		<td class="label_right" colspan="5">guadagno</td>
		<td class="content_right" colspan="2"><strong><%'= FormatPrice(((sp_altre*100)/(sp_tot - sp_altre)) , 2, true) %>&nbsp;%</strong></td>
		<% if modificabile then %><td class="content" colspan="4">&nbsp;</td><% end if %>
	</tr>
<%
dim a
a="URL " & GetPageSiteUrl(conn, Session("SHOPPING_CART_COMPLETATA_PAGE"), "it") & "&IDCNT=" & rs("IDElencoIndirizzi") & "&KEY=" & rs("codiceInserimento") & "&ID=" & rs("ord_id") & "&TYPEREQ=admin"
'response.write a

end sub


'......................................................................................................
'	funzione utilizzata nel salvataggio dei dati dell'ordine
'......................................................................................................
sub ADDON__ORDINI__form_salva(conn, rs)
end sub

%>